<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Stylesheets & Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9fafb;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .icon {
            font-size: 2rem;
            margin-right: 10px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-7xl mx-auto space-y-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row gap-4 items-center justify-end">
        <div class="flex gap-2">
            <a th:href="@{/homepage}" class="px-4 py-2 bg-blue-300 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">Homepage</a>
        </div>
        <div class="flex gap-2">
            <a th:href="@{/employee}" class="px-4 py-2 bg-blue-300 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">Employee</a>
        </div>
        <div class="flex gap-2">
            <a th:href="@{/attendance}" class="px-4 py-2 bg-blue-300 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">Attendance</a>
        </div>
        <div class="flex gap-2">
            <a th:href="@{/payroll}" class="px-4 py-2 bg-blue-300 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">Payroll</a>
        </div>
        <div class="flex gap-2">
            <a th:href="@{/request}" class="px-4 py-2 bg-blue-300 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">Request</a>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard w-full max-w-5xl">
        <div class="card"><i class="icon fas fa-user text-blue-500"></i><div><p>Tổng số nhân viên</p><h2>2</h2></div></div>
        <div class="card"><i class="icon fas fa-clock text-yellow-500"></i><div><p>Chấm công hôm nay</p><h2>135/150</h2></div></div>
        <div class="card"><i class="icon fas fa-money-bill text-green-500"></i><div><p>Lương đang xử lý</p><h2>12</h2></div></div>
        <div class="card"><i class="icon fas fa-tasks text-red-500"></i><div><p>Yêu cầu chờ duyệt</p><h2>8</h2></div></div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 w-full max-w-5xl mt-5">
        <div class="chart-container">
            <h2 class="text-lg font-bold">Biểu đồ nhân viên</h2>
            <canvas id="employeeChart"></canvas>
        </div>
        <div class="chart-container">
            <h2 class="text-lg font-bold">Hoạt động hàng tuần</h2>
            <canvas id="attendanceChart"></canvas>
        </div>
        <div class="chart-container col-span-2">
            <h2 class="text-lg font-bold">Tổng quan lương</h2>
            <label for="yearPicker">Chọn năm:</label>
            <input type="number" id="yearPicker" min="2000" max="2100" step="1" value="2020" class="border p-2 rounded">
            <canvas id="payrollChart"></canvas>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        fetchEmployeeData();
        fetchAttendanceData();
        fetchPayrollData();

        document.getElementById("yearPicker").addEventListener("change", fetchPayrollData);
    });

    async function fetchEmployeeData() {
        try {
            const response = await fetch("/api/employee/employeeAvailable");
            const data = await response.json();
            new Chart(document.getElementById("employeeChart"), {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Unavailable'],
                    datasets: [{
                        data: [data.totalAvailableEmployees, data.totalUnavailableEmployees],
                        backgroundColor: ['#36A2EB', '#FF6384']
                    }]
                }
            });
        } catch (error) {
            console.error("Lỗi khi lấy dữ liệu nhân viên: ", error);
        }
    }

    async function fetchAttendanceData() {
        try {
            const response = await fetch("/api/attendance/attendancesByDay?date=2025-03-03");
            const data = await response.json();
            new Chart(document.getElementById("attendanceChart"), {
                type: 'doughnut',
                data: {
                    labels: ['Attendance', 'Late', 'Absent'],
                    datasets: [{
                        data: [data.workedEmployee, data.lateEmployee, data.absenceEmployee],
                        backgroundColor: ['#36A2EB', '#face00', '#ff0000']
                    }]
                }
            });
        } catch (error) {
            console.error("Lỗi khi lấy dữ liệu chấm công: ", error);
        }
    }

    async function fetchPayrollData() {
        try {
            let year = document.getElementById("yearPicker").value;
            if(year == null) year = new Date.now().getFullYear();
            const response = await fetch(`/api/payroll/totalpayrollByYear?year=${year}`);
            const data = await response.json();

            let months = [];
            let totals = [];

            data.forEach((d) => {
                months.push(d.month)
                totals.push(d.total)
            })

            new Chart(document.getElementById("payrollChart"), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: totals,
                        backgroundColor: ['#36A2EB', '#face00', '#ff0000']
                    }]
                }
            });
        } catch (error) {
            console.error("Lỗi khi lấy dữ liệu lương: ", error);
        }
    }
</script>

</body>
</html>
