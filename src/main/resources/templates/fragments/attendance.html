

<div class="container mx-auto p-6 max-w-7xl">
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Date Range</label>
            <input id="daterange" name="dates" class="w-full p-2 border rounded-md cursor-pointer">
        </div>

        <form action="/search" th:action="@{/attendance/search}" method="get">
            <input type="text" name="search" placeholder="Search employee by name" th:value="${employeeName}"/>
            <button type="submit">Search</button>
        </form>

        <div class="mt-4">
            <form th:action="@{/attendance/filter}" method="get" class="flex items-center gap-2">
                <input type="hidden" name="field" value="department">
                <label class="text-sm font-medium text-gray-700">Filter Department:</label>
                <select name="value" onblur="this.form.submit()"
                        class="rounded border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    <option value="all"
                            th:selected="${(param.value == null) || (param.value[0] == 'all')}">All Departments
                    </option>
                    <option th:each="d : ${departments}"
                            th:value="${d.getDepartmentId()}"
                            th:text="${d.getDepartmentName()}"
                            th:selected="${(param.value != null) && (param.value[0] == T(java.lang.String).valueOf(d.getDepartmentId()))}">
                </select>
            </form>
        </div>
    </div>
    <div class="mt-8 mb-6 flex justify-end">
        <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Export dữ liệu
        </button>
        <button id="createBtn" class="ml-3 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
            Thêm mới
        </button>
    </div>
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
            <tr class="grid grid-cols-12 gap-x-4 py-3 px-4 border-b">
                <th class="col-span-1 text-left text-sm font-medium text-gray-500">
                    <input id="header-checkbox" type="checkbox" class="rounded border-gray-300"/>
                </th>
                <th class="col-span-3 text-left text-sm font-medium text-gray-500">Employee Name</th>
                <th class="col-span-2 text-left text-sm font-medium text-gray-500">Date</th>
                <th class="col-span-2 text-left text-sm font-medium text-gray-500">Clock-in</th>
                <th class="col-span-2 text-left text-sm font-medium text-gray-500">Clock-out</th>
                <th class="col-span-1 text-left text-sm font-medium text-gray-500">Overtime</th>
                <th class="col-span-1 text-left text-sm font-medium text-gray-500">Note</th>
            </tr>
            </thead>

            <tbody class="divide-y divide-gray-200">
            <tr th:each="a, iterStat : ${attendances.content}"
                class="grid grid-cols-12 gap-x-4 py-3 px-4 hover:bg-gray-50 transition-colors">
                <td class="col-span-1 flex items-center">
                    <input class="checkboxes rounded border-gray-300" type="checkbox" th:value="${a.getEmployeeId()}"/>
                </td>
                <td class="col-span-3">
                    <a th:href="@{/attendance/view/detail(employeeId=${a.getEmployeeId()})}"
                       class="text-blue-600 hover:underline"
                       th:text="${a.getFirstName() + ' ' + a.getLastName()}"/>
                </td>
                <td class="attendanceDates col-span-2" th:text="${a.getAttendanceDate()}"></td>
                <td class="attendanceCheckIn col-span-2" th:text="${#temporals.format(a.getAttendanceCheckIn(), 'HH:mm:ss')}"></td>
                <td class="attendanceCheckOut col-span-2" th:text="${#temporals.format(a.getAttendanceCheckOut(), 'HH:mm:ss')}"></td>
                <td class="col-span-1" th:text="${a.getAttendanceStatus()}"></td>
                <td class="col-span-1 truncate" th:text="${a.getAttendanceNote()}"></td>
            </tr>
            </tbody>
        </table>

        <div class="p-4 border-t">
            <div class="flex items-center justify-between">
                <div class="flex gap-2">
                        <span th:if="${attendances.hasPrevious()}">
                            <a th:href="@{/attendance/filter(dates=${#strings.listJoin(dates, ',')}, page=${attendances.number - 1})}"
                               class="px-3 py-1 rounded border text-gray-700 hover:bg-gray-100 transition-colors">
                                Previous
                            </a>
                        </span>
                </div>

                <div class="flex gap-1">
                        <span th:each="i : ${#numbers.sequence(0, attendances.totalPages - 1)}">
                            <a th:if="${i != attendances.number}"
                               th:href="@{/attendance/filter(dates=${#strings.listJoin(dates, ',')}, page=${i})}"
                               class="px-3 py-1 rounded border text-gray-700 hover:bg-gray-100 transition-colors"
                               th:text="${i + 1}"></a>
                            <span th:unless="${i != attendances.number}"
                                  class="px-3 py-1 rounded border bg-blue-500 text-white"
                                  th:text="${i + 1}"></span>
                        </span>
                </div>

                <div class="flex gap-2">
                        <span th:if="${attendances.hasNext()}">
                            <a th:href="@{/attendance/filter(dates=${#strings.listJoin(dates, ',')}, page=${attendances.number + 1})}"
                               class="px-3 py-1 rounded border text-gray-700 hover:bg-gray-100 transition-colors">
                                Next
                            </a>
                        </span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var headerCheckbox = document.getElementById("header-checkbox");
        headerCheckbox.addEventListener("click", () => {
            var checkboxes = document.getElementsByClassName("checkboxes");
            for (var checkbox of checkboxes) {
                checkbox.checked = !checkbox.checked;
            }
        });

        var createBtn = document.getElementById("createBtn");
        createBtn.addEventListener("click", function () {
            var checkboxes = document.getElementsByClassName("checkboxes");
            var attendanceDates = document.getElementsByClassName("attendanceDates");
            var attendanceCheckIn = document.getElementsByClassName("attendanceCheckIn")
            var attendanceCheckOut = document.getElementsByClassName("attendanceCheckOut")
            var ids = [];
            var dates = [];
            var checkIns = [];
            var checkOuts = [];

            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    ids.push(checkboxes[i].value);
                    dates.push(attendanceDates[i].textContent.trim());
                    checkIns.push(attendanceCheckIn[i].textContent.trim())
                    checkOuts.push(attendanceCheckOut[i].textContent.trim())
                }
            }

            window.location.href =
                `/attendance/create/form?employeeIds=${encodeURIComponent(ids.join(','))}&dates=${encodeURIComponent(dates.join(','))}&checkIns=${encodeURIComponent(checkIns.join(','))}&checkOuts=${encodeURIComponent(checkOuts.join(','))}`;
        });

        const urlParams = new URLSearchParams(window.location.search);
        const datesParam = urlParams.get('dates');

        let startDate = moment().subtract(29, 'days');
        let endDate = moment();

        if (datesParam) {
            const [startStr, endStr] = datesParam.split(',');
            startDate = moment(startStr);
            endDate = moment(endStr);
        }

        $('#daterange').daterangepicker({
            opens: 'center',
            autoApply: true,
            startDate: startDate,
            endDate: endDate,
            locale: {
                format: 'MM/DD/YYYY'
            },
            ranges: {
                'today':[moment()],
                'Last 7 Days': [moment().subtract(7, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'Last 3 Months': [moment().subtract(2, 'month').startOf('month'), moment().endOf('month')],
                'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
            }
        }, function (start, end) {
            window.location.href = `/attendance/filter?field=startDate,endDate&dates=${start.format('YYYY-MM-DD')},${end.format('YYYY-MM-DD')}`;
        });

    });
</script>