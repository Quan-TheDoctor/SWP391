<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="main-content" xmlns:sec="http://www.w3.org/1999/xhtml">
    <main class="flex-1 ml-64 p-6">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between p-4 bg-gradient-to-r from-primary-600 to-secondary-600 rounded-lg text-white shadow-lg animate__animated animate__fadeIn">
                <div>
                    <h1 class="text-2xl font-bold">Attendance Charts</h1>
                    <p class="text-primary-100">Visual attendance data analysis for <span th:text="${selectedYear}">2025</span></p>
                </div>

                <div class="flex gap-2">
                    <a th:href="@{/attendance/summary}"
                       class="px-4 py-2 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-800 transition-all duration-200">
                        Back to Summary
                    </a>
                </div>
            </div>

            <!-- Filter Section -->
            <form th:action="@{/attendance/summary/chart}" method="get" id="chartFilterForm" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate__animated animate__fadeIn">
                <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Department</h2>
                    <select name="selectedDepartmentId" id="departmentFilter"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            onchange="document.getElementById('chartFilterForm').submit()">
                        <option value="0" th:selected="${selectedDepartmentId == null || selectedDepartmentId == 0}">All Departments</option>
                        <option th:each="d : ${departments}"
                                th:value="${d.departmentId}"
                                th:text="${d.departmentName}"
                                th:selected="${selectedDepartmentId == d.departmentId}">
                        </option>
                    </select>
                </div>

                <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Year</h2>
                    <select id="yearFilter" name="selectedYear"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            onchange="document.getElementById('chartFilterForm').submit()">
                        <option value="2022" th:selected="${selectedYear == 2022}">2022</option>
                        <option value="2023" th:selected="${selectedYear == 2023}">2023</option>
                        <option value="2024" th:selected="${selectedYear == 2024}">2024</option>
                        <option value="2025" th:selected="${selectedYear == 2025 || selectedYear == null}">2025</option>
                    </select>
                </div>

                <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Chart Type</h2>
                    <select id="chartTypeSelector"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            onchange="updateChartType()">
                        <option value="line">Line Chart</option>
                        <option value="bar">Bar Chart</option>
                        <option value="area">Area Chart</option>
                    </select>
                </div>
            </form>

            <!-- Chart Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 animate__animated animate__fadeInUp">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <span th:text="${departmentName}">All Departments</span> - Attendance Statistics <span th:text="${selectedYear}">2025</span>
                    </h2>

                    <div class="flex flex-wrap gap-3 mt-3 md:mt-0">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>
                            <span class="text-sm text-gray-600">On Time</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-yellow-500 rounded-full mr-1"></span>
                            <span class="text-sm text-gray-600">Late</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>
                            <span class="text-sm text-gray-600">Absent</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
                            <span class="text-sm text-gray-600">Overtime</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Container -->
                <div id="attendanceChart" style="width: 100%; height: 500px;"></div>

                <!-- Chart Data (hidden) -->
                <div id="chartData" class="hidden"
                     th:data-months="[[${months}]]"
                     th:data-ontime="[[${onTimeData}]]"
                     th:data-late="[[${lateData}]]"
                     th:data-absent="[[${absentData}]]"
                     th:data-overtime="[[${overtimeData}]]">
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate__animated animate__fadeIn">
                <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-3">
                        <i class="fas fa-check text-2xl text-green-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-green-600" th:text="${#aggregates.sum(onTimeData)}">0</h2>
                    <p class="text-gray-600 font-medium">Total On Time Days</p>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center mb-3">
                        <i class="fas fa-clock text-2xl text-yellow-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-yellow-600" th:text="${#aggregates.sum(lateData)}">0</h2>
                    <p class="text-gray-600 font-medium">Total Late Days</p>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-3">
                        <i class="fas fa-times text-2xl text-red-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-red-600" th:text="${#aggregates.sum(absentData)}">0</h2>
                    <p class="text-gray-600 font-medium">Total Absent Days</p>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-3">
                        <i class="fas fa-hourglass-half text-2xl text-blue-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-blue-600" th:text="${#aggregates.sum(overtimeData)}">0</h2>
                    <p class="text-gray-600 font-medium">Total Overtime Hours</p>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript for Chart -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Get chart data from hidden div
            const chartDataElement = document.getElementById('chartData');
            const months = JSON.parse(chartDataElement.getAttribute('data-months'));
            const onTimeData = JSON.parse(chartDataElement.getAttribute('data-ontime'));
            const lateData = JSON.parse(chartDataElement.getAttribute('data-late'));
            const absentData = JSON.parse(chartDataElement.getAttribute('data-absent'));
            const overtimeData = JSON.parse(chartDataElement.getAttribute('data-overtime'));

            // Initialize chart
            const chartDom = document.getElementById('attendanceChart');
            const myChart = echarts.init(chartDom);

            // Initial chart options
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['On Time', 'Late', 'Absent', 'Overtime'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: months,
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Days',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    {
                        type: 'value',
                        name: 'Hours',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: 'On Time',
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#10B981'  // green-500
                        },
                        data: onTimeData
                    },
                    {
                        name: 'Late',
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#F59E0B'  // yellow-500
                        },
                        data: lateData
                    },
                    {
                        name: 'Absent',
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#EF4444'  // red-500
                        },
                        data: absentData
                    },
                    {
                        name: 'Overtime',
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            width: 3,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#3B82F6'  // blue-500
                        },
                        yAxisIndex: 1,
                        data: overtimeData
                    }
                ]
            };

            // Apply options to chart
            myChart.setOption(option);

            // Make chart responsive
            window.addEventListener('resize', function() {
                myChart.resize();
            });

            // Expose chart and data for other functions
            window.attendanceChart = {
                chart: myChart,
                data: {
                    months: months,
                    onTimeData: onTimeData,
                    lateData: lateData,
                    absentData: absentData,
                    overtimeData: overtimeData
                },
                options: option
            };
        });

        // Function to update chart type
        function updateChartType() {
            const chartType = document.getElementById('chartTypeSelector').value;
            const chart = window.attendanceChart.chart;
            const data = window.attendanceChart.data;
            const options = window.attendanceChart.options;

            // Update series type
            const newOptions = {
                series: [
                    {
                        name: 'On Time',
                        type: chartType === 'area' ? 'line' : chartType,
                        smooth: true,
                        areaStyle: chartType === 'area' ? {} : null,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#10B981'
                        },
                        data: data.onTimeData
                    },
                    {
                        name: 'Late',
                        type: chartType === 'area' ? 'line' : chartType,
                        smooth: true,
                        areaStyle: chartType === 'area' ? {} : null,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#F59E0B'
                        },
                        data: data.lateData
                    },
                    {
                        name: 'Absent',
                        type: chartType === 'area' ? 'line' : chartType,
                        smooth: true,
                        areaStyle: chartType === 'area' ? {} : null,
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: '#EF4444'
                        },
                        data: data.absentData
                    },
                    {
                        name: 'Overtime',
                        type: chartType === 'area' ? 'line' : chartType,
                        smooth: true,
                        areaStyle: chartType === 'area' ? {} : null,
                        lineStyle: {
                            width: 3,
                            type: chartType === 'line' || chartType === 'area' ? 'dashed' : 'solid'
                        },
                        itemStyle: {
                            color: '#3B82F6'
                        },
                        yAxisIndex: 1,
                        data: data.overtimeData
                    }
                ]
            };

            // Apply new options
            chart.setOption(newOptions);
        }
    </script>
</div>
</html>
